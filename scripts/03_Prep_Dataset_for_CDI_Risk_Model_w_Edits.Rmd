---
title: "Prepare Dataset for CDI Risk Assessment Model"
author: "Steph Reynolds"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Background

## Project

MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description

This file reads in necessary data and identifies variables of interest for building a multivariate logistic regression model to evaluate C diff risk among hospitalized patients. The resulting data frame (`df.CDI`) contains binary indicators for CDI risk factors. Variables include:

-   `ID` --\> each patient's unique de-identified encounter ID
-   `readmit` --\> whether patient had a prior hospital admission in the last 30 days
-   `ED_dispo` --\> whether pt was admitted from Emergency Dept (ED) ???
    -   NOTE: UNCLEAR! VERIFY / LEO WHAT THIS SHOULD BE TO INDICATE THAT PT WAS ADMITTED TO ED!
-   `age_gte_65` --\> whether pt is aged 65 years or older at time of hospitalization
-   `PPI` --\> whether pt received proton pump inhibitor (PPI) during hospital stay
-   `GAS` --\> whether pt received gastric acid suppressants (GAS) during hospital stay
    -   NOTE: This includes "ANTACIDS" and "HISTAMINE H2-RECEPTOR INHIBITORS"
-   `anyGAS` --\> whether pt received PPI and/or GAS during hospital stay
-   `LAX` --\> whether pt received laxatives (LAX) during hospital stay
    -   NOTE: This includes "LAXATIVES AND CATHARTICS" and "LAXATIVES, LOCAL/RECTAL"
-   `ABX` --\> whether pt received antibiotics during hospital stay
    -   NOTE: THIS DOES NOT INCLUDE OUTPATIENT ABX - ONLY THOSE DURING HOSPITALIZATION.
-   `DBM` --\> whether pt is diagnosed with diabetes mellitus (DBM)
    -   NOTE: DO NOT USE! ONLY HAVE DBM DX FOR COVID-POSITIVE PTS.

# Load required packages

```{r Load required packages}
library(tidyverse)
library(lubridate)
library(tableone) # create categorical tables
library(DescTools) # %like% operator
```

# Import `dm`, `med`, and `lab` tables

```{r Import data, message = F}
dm <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/demographics and event table 11.08.21.csv", delim = "|")

med <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/med admin table 11.08.21.csv", delim = "|")

lab <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/lab results 11.08.21.csv", delim = "|")

dx <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/covid diagnoses 11.08.21.csv", delim = "|")
```

# Clean `lab` table and identify all patients who had an abnormal CDIF test

```{r Clean `lab` table}
# Create not-like operator
`%notlike%` <- Negate(`%like%`)

# Create vector to exclude those where ORD_VALUE=='Test not performed'|'Indeterminate'
exclude_ord_value <- "Test not performed|Indeterminate"

# Identify all patients who had an abnormal CDIF test and assign to table `cdif_pts`
cdif_pts <- lab %>% 
  filter(COMPONENT_ID=='1301' & 
           Abnormal=='Abnormal' & 
           ORD_VALUE %notlike% exclude_ord_value) %>% 
  group_by(deid_enc_id) %>% 
  filter(order_time==min(order_time)) %>% 
  ungroup() %>% 
  distinct(deid_enc_id, order_time, RESULT_TIME) %>% 
  rename(CDIF_order_time = order_time,
         CDIF_result_time = RESULT_TIME)

# Identify all patients who had an abnormal diabetes test and assign to table `diabetes_pts`
diabetes_pts <- lab %>% 
  filter(lab_concept == "diabetes" & 
           Abnormal != "NULL") %>% 
  select(deid_enc_id, lab_concept, Abnormal, order_time, RESULT_TIME) %>% 
  distinct(deid_enc_id, Abnormal)
```

#  

# Join `dm` and `cdif_pts` tables and create new vars to indicate age\>=65, readmit status, and hospital-acquired CDIF

**\*Note:** Hospital-acquired CDIF (`HACDIF`) is defined as those with CDIF orders (`CDIF_order_time`) more than 48 hours after admission (`admit_time`).

```{r Join `dm` and `cdif_pts` tables}
df <- dm %>% 
  full_join(cdif_pts, by = "deid_enc_id") %>% # Join `dm` with `cdif_pts` table
  select(deid_enc_id, age, readmit, ED_dispo, admit_time, CDIF_order_time, CDIF_result_time) %>%
  mutate_at(c("admit_time", "CDIF_order_time", "CDIF_result_time"), ymd_hms) %>% 
  mutate_at(c("readmit", "ED_dispo"), factor) %>%
  mutate(age_gte_65 = if_else(age>=65, 1, 0),
         readmit = if_else(readmit=="Yes", 1, 0),
         HACDIF = case_when((difftime(CDIF_order_time, admit_time, units = "hours")) > 48 ~ 1, TRUE ~ 0)) # should this be difference in order_time or result_time???

# Calculate proportion of encounter IDs with HACDIF 
cat("Proportion of total encounter IDs with hospital-acquired CDIF:",
    round(sum(df$HACDIF)/length(df$deid_enc_id), 4))
```

# Create binary variables to indicate whether patients received PPI, GAS, LAX, and/or ABX; assign to table `med2`

```{r Create binary vars to indicate whether pts received PPI, GAS, LAX, ABX}
# Create vector for names of common antibiotics
names_of_abx <- "VANCOMYCIN|CEFTRIAXONE|CEFEPIME|LEVOFLOXACIN|CIPROFLOXACIN|AMIKACIN|GENTAMICIN|NEOMYCIN-POLYMYXIN|TOBRAMYCIN|ERTAPENEM|IMIPENEM-CILASTATIN|MEROPENEM|MEROPENEM-VABORBACTAM|CEFAZOLIN|CEFOXITIN|CEFOTETAN|CEFUROXIME|CEFTAZIDIME|CEFTAROLINE|TOBRAMYCIN|DALBAVANCIN|ORITAVANCIN|CLINDAMYCIN|DAPTOMYCIN|AZITHROMYCIN|ERYTHROMYCIN|AZTREONAM|LINEZOLID|AMPICILLIN|AMPICILLIN-SULBACTAM|NAFCILLIN|PENICILLIN|PIPERACILLIN-TAZOBACTAM|BACITRACIN|NEOMYCIN-POLYMYXIN|GENTAMICIN-POLYMYXIN|TRIMETHOPRIM-SULFAMETHOXAZOLE|SULFAMETHOXAZOLE-TRIMETHOPRIM|DOXYCYCLINE|MINOCYCLINE|CLOFAZIMINE|ISONIAZID|RIFAMPIN|TIGECYCLINE|TRIMETHOPRIM|ACYCLOVIR|CASPOFUNGIN|LETERMOVIR|GANCICLOVIR|ACYCLOVIR|POSACONAZOLE|AMPHOTERICIN|AZTREONAM|GENTAMICIN|CASIRIVIMAB|CEFIDEROCOL|CEFTOLOZANE-TAZOBACTAM|CIDOFOVIR|CLINDAMYCIN|COLISTIMETHATE|ALBAVANCIN|ERAVACYCLINE|FOSCARNET|GENTAMICIN-POLYMYXIN|REMDESIVIR|ISAVUCONAZONIUM|LINEZOLID|MASTOID POWDER|MICAFUNGIN|CEFAZOLIN/CEFTAZIDIME|ORITAVANCIN|PENICILLIN|PERAMIVIR|TEDIZOID|TRIMETHOPRIM-SULFAMETHOXAZOLE|VORICONAZOLE|BACITRACIN|IBALIZUMAB-UIYK|CENICRIVIROC|BAMLANIVIMAB-ETESEVIMAB|BAMLANIVIMAB|BEZLOTOXUMAB"
# need to confirm this list of abx names 

# Create variables to indicate whether pt received PPI, GAS, anyGAS, LAX and ABX
med2 <- med %>% 
  select(deid_enc_id, name, thera_class, pharm_class, taken_time) %>% 
  mutate_at(c("thera_class", "pharm_class"), factor) %>%
  mutate(PPI = if_else(pharm_class=="PROTON-PUMP INHIBITORS" | name %like% "PANTOPRAZOLE", 1, 0),    
         GAS = if_else(pharm_class %in% c("ANTACIDS", "HISTAMINE H2-RECEPTOR INHIBITORS"), 1, 0),
         anyGAS = if_else(pharm_class %in% c("PROTON-PUMP INHIBITORS", "ANTACIDS", "HISTAMINE H2-RECEPTOR INHIBITORS") | name %like% "PANTOPRAZOLE", 1, 0),
         LAX = if_else(pharm_class %in% c("LAXATIVES AND CATHARTICS", "LAXATIVES, LOCAL/RECTAL"), 1, 0),
         ABX = if_else(thera_class %in% c("ANTIBIOTICS", "ANTIFUNGALS", "ANTIINFECTIVES/MISCELLANEOUS", "ANTIPARASITICS","ANTIVIRALS") | name %like% names_of_abx, 1, 0)) %>% 
  select(-c(thera_class, pharm_class))
```

# Create `med_taken_before_HAI` table to indicate whether pt received PPI, GAS, or ABX up to one day before CDIF_order_time

**NOTE TO SELF:** Need to edit this section so that all ABX/PPI/GAS are counted, regardless of whether they were received up to one day before `CDIF_order_time`. Need to edit filter (line 3).

```{r Create `med_taken_before_HAI` table}
# ANOTHER ATTEMPT
sample <- df %>% 
  left_join(med2, by = "deid_enc_id") %>% 
  group_by(deid_enc_id) %>%
  mutate(PPI = if_else(sum(PPI)>=1, 1, 0),
         GAS = if_else(sum(GAS)>=1, 1, 0),
         anyGAS = if_else(sum(anyGAS)>=1, 1, 0),
         LAX = if_else(sum(LAX)>=1, 1, 0),
         ABX = if_else(sum(ABX)>=1, 1, 0),
         taken_after_order = if_else(taken_time > CDIF_order_time, 1, 0))

# PRIOR ATTEMPT 
med_taken_before_HACDIF <- df %>% 
  left_join(med2, by = "deid_enc_id") %>%     # Left join dm and med tables on ID
  filter(taken_time < CDIF_order_time) %>%    # Filter for where  taken_time (for PPI, ABX, or GAS) < CDIF_order_time
  group_by(deid_enc_id) %>%                   # Group by ID
  summarize(Num_of_PPI = sum(PPI),            # Count total number of PPI, GAS, anyGAS, LAX, ABX up to day before HCDIF
            Num_of_GAS = sum(GAS),
            Num_of_anyGAS = sum(anyGAS),
            Num_of_LAX = sum(LAX),
            Num_of_ABX = sum(ABX)) %>% 
  mutate(PPI = if_else(Num_of_PPI>=1, 1, 0),  # Transform to binary vars, indicating yes/no whether pt received PPI, GAS, or ABX
         GAS = if_else(sum(GAS)>=1, 1, 0),
         anyGAS = if_else(sum(anyGAS)>=1, 1, 0),
         LAX = if_else(sum(LAX)>=1, 1, 0),
         ABX = if_else(sum(ABX)>=1, 1, 0)) %>% 
  select(deid_enc_id, PPI, GAS, anyGAS, LAX, ABX)   # Only keep relevant variables

# Rather than number of PPI/GAS/anyGAS/LAX/ABX, should this just be a binary variable indicating receipt of PPI/GAS/anyGAS/LAX/ABX (coded as 1=yes or 0=no)? Section commented above handles this. Can remove this chunk of code if decide it's better to have frequency counts for PPI/GAS/anyGAS/LAX/ABX. 


#### Random code - don't delete yet 
full <- dm %>% 
  left_join(med2, by = "deid_enc_id") %>% 
  filter(ABX==0 & thera_class=="NULL") %>% 
  select(deid_enc_id, name, thera_class, pharm_class)

full %>% distinct(name, .keep_all = T) %>% write_csv("/Users/sreynolds2/Documents/GitHub/MS-CDI_Risk/MS-CDI_Risk/data/check_for_abx.csv")


#### Random code - don't delete yet 
full <- full %>% 
  mutate(abx_yn = case_when(ABX==1 & (taken_time < HAI_first_date | is.na(HAI_first_date)) ~ 1))

full %>% summarize(n_distinct(deid_enc_id)) 


# REPLICATE CODE BUT KEEP FREQUENCY COUNTS OF ABX, INSTEAD OF CONVERTING TO BINARY VARIABLE (Y/N).
med_taken_before_HAI_2 <- dm %>% 
  left_join(med2, by = "deid_enc_id") %>%     # Left join dm and med tables on ID
  filter(taken_time < HAI_first_date) %>%     # Filter for where  taken_time (for PPI, ABX, or GAS) < HAI_first_date
  group_by(deid_enc_id) %>%                   # Group by ID
  summarize(Num_of_PPI = sum(PPI),            # Count total number of PPI, GAS, anyGAS, LAX, ABX up to day before HAI_first_date
            Num_of_GAS = sum(GAS),
            Num_of_anyGAS = sum(anyGAS),
            Num_of_LAX = sum(LAX),
            Num_of_ABX = sum(ABX)) 

num_of_abx <- med_taken_before_HAI_2 %>% select(c(deid_enc_id, Num_of_ABX))
num_of_abx %>% filter(Num_of_ABX!=0)
sum(med_taken_before_HAI_2$Num_of_ABX)
```

# Clean `dx` table and create binary variable to indicate whether patient has diabetes; assign to table `dbm`

```{r Clean `dx` table, create table to indicate DBM dx}
dbm <- dx %>% 
  mutate(DBM = if_else(dx_group=="DIABETES MELLITUS", 1, 0)) %>%
  group_by(deid_enc_id) %>% 
  summarize(n_dbm = sum(DBM)) %>% 
  mutate(DBM = if_else(n_dbm>=1, 1, 0)) %>% 
  select(-n_dbm)
```

**NOTE:** Only have diabetes diagnoses for 1,210 out of 54,955 patients. Missing data on DBM diagnosis for \~97% of patients. Only have DBM data for Covid-positive patients. Checked demographics and events table, and diabetes dx not listed as variable. Would need Leo to re-pull data gathering diabetes dx for ALL patients.

# Join `df`, `med_taken_before_HACDIF`, and `dbm` tables and assign to `df_CDI`

```{r Merge all tables}
df_CDI <- df %>% 
  left_join(med_taken_before_HACDIF, by = 'deid_enc_id') %>% # Left join dm and med_taken_before_HACIDF
  left_join(dbm, by = "deid_enc_id") %>%          # Left join dm and dbm
  mutate(PPI = ifelse(is.na(PPI), 0, PPI),        # Reassign NA values for PPI:DBM to 0
         GAS = ifelse(is.na(GAS), 0, GAS),
         anyGAS = ifelse(is.na(anyGAS), 0, anyGAS),
         LAX = ifelse(is.na(LAX), 0, LAX),
         ABX = ifelse(is.na(ABX), 0, ABX), 
         DBM = ifelse(is.na(DBM), 0, DBM)) %>%
  rename(ID = deid_enc_id)                    # Rename to ID for convenience

# df_CDI <- mutate_at(df_CDI, vars(c(readmit, age_gte_65, HACDIF, PPI, GAS, anyGAS, LAX, ABX, DBM)), factor)
```

# Preview final dataset

```{r Preview and explore `df_CDI`}
str(df_CDI)
summary(df_CDI)
```

# Calculate descriptives for categorical variables in `df_CDI`

```{r Create table one of descriptives}
tableone <- CreateCatTable(data=df_CDI, vars=c("readmit", "ED_dispo", "age_gte_65", "HACDIF", "PPI", "GAS", "anyGAS", "LAX", "ABX", "DBM"))

print(tableone, showAllLevels = T, noSpaces = T)

# For binary variables, 1 = YES and 0 = NO. 
```

# Save resulting dataset `df_CDI` as CSV and RDS file

```{r Save resulting dataset as CSV and RDS}
write_csv(df_CDI, "/Users/sreynolds2/Documents/GitHub/MS-CDI_Risk/MS-CDI_Risk/data/clean/df_CDI_risk_model.csv")
saveRDS(df_CDI, "/Users/sreynolds2/Documents/GitHub/MS-CDI_Risk/MS-CDI_Risk/data/clean/df_CDI_risk_model.rds")
```
