---
title: "Prepare Dataset for CDI Risk Assessment Model"
author: "Steph Reynolds"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Background

## Project 
MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description 
This file reads in necessary data and identifies variables of interest for building a multivariate logistic regression model to evaluate C diff risk among hospitalized patients. The resulting dataframe (`df.CDI`) contains binary indicators for CDI risk factors. Variables include:

  * `ID` --> each patient's unique de-identified encounter ID 
  * `readmit` --> whether patient had a prior hospital admission in the last 30 days
  * `ED_dispo` --> whether pt was admitted from Emergency Dept (ED) ???
    - UNCLEAR! VERIFY / LEO WHAT THIS SHOULD BE TO INDICATE THAT PT WAS ADMITTED TO ED!
  * `age_gte_65` --> whether pt is aged 65 years or older at time of hospitalization
  * `PPI` --> whether pt received proton pump inhibitor (PPI) during hospital stay
  * `GAS` --> whether pt received gastric acid suppressants and laxatives (GAS) during hospital stay
    - This includes "ANTACIDS", "LAXATIVES AND CATHARTICS", and "LAXATIVES, LOCAL/RECTAL"
  * `ABX` --> whether pt received antibiotics during hospital stay 
    - NOTE: THIS DOES NOT INCLUDE OUTPATIENT ABS - ONLY THOSE DURING HOSPITALIZATION. 
  * `DBM` --> whether pt is diagnosed with diabetes mellitus (DBM) 
    - NOTE: ONLY HAVE DBM DX INFO FROM 1,210 PTS.

# Load required packages 
```{r Load packages}
# Load required packages 
library(readr)
library(tidyverse)
library(lubridate)
library(tableone)
library(kableExtra)
library(DT)
```

# Import `dm` and `med_admin` tables 
```{r Import data}
dm <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/demographics and event table 11.08.21.csv", delim = "|")

med <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/med admin table 11.08.21.csv", delim = "|")

dx <- read_delim("/Users/sreynolds2/Downloads/ucsf_data_pull_11.08.21/covid diagnoses 11.08.21.csv", delim = "|")
```

# Clean `dm` table - deselect unnecessary variables, change to appropriate variable type
```{r Clean `dm` table}
dm <- dm %>% 
  select(deid_enc_id, age, readmit, HAI_type, HAI_first_date, ED_dispo, admit_time) %>% 
  mutate_at(c("readmit", "ED_dispo", "HAI_type"), factor) %>% 
  mutate(HAI_first_date = substr(HAI_first_date, 1,20)) %>% 
  mutate_at(c("admit_time", "HAI_first_date"), ymd_hms) %>% 
  mutate(age_gte_65 = if_else(age>=65, 1, 0),
         readmit = if_else(readmit=="Yes", 1, 0),
         cdif = if_else(HAI_type=="CDIF", 1, 0),
         gt_2_days = if_else((difftime(HAI_first_date, admit_time, units = "days")) > 2, 1, 0),
         # Add column to indicate whether CDIFF dx was > 2 days of admission
         cdif_gt_2_days = if_else(cdif==1 & gt_2_days==1, 1, 0)) %>% 
  select(-c(age, HAI_type, HAI_first_date, admit_time, cdif, gt_2_days))
```

# Clean `med` table - deselect unnecessary variables, change to appropriate variable type
```{r Clean `med_admin` table}
med <- med %>% 
  select(deid_enc_id, thera_class, pharm_class) %>% 
  mutate_at(c("thera_class", "pharm_class"), factor) %>% 
  mutate(PPI = if_else(pharm_class=="PROTON-PUMP INHIBITORS", 1, 0),
         GAS = if_else(pharm_class %in% c("ANTACIDS", "LAXATIVES AND CATHARTICS", "LAXATIVES, LOCAL/RECTAL"), 1, 0),
         ABX = if_else(thera_class %in% c("ANTIBIOTICS", "ANTIFUNGALS", "ANTIINFECTIVES/MISCELLANEOUS", "ANTIPARASITICS", "ANTIVIRALS"), 1, 0)) %>% 
  select(-c(thera_class, pharm_class))

med <- med %>% 
  group_by(deid_enc_id) %>% 
  summarize(Num_of_PPI = sum(PPI),
            Num_of_GAS = sum(GAS),
            Num_of_ABX = sum(ABX)) %>% 
  mutate(PPI = if_else(Num_of_PPI>=1, 1, 0),            # this transforms PPI, GAS, and ABX into binary vars
         GAS = if_else(Num_of_GAS>=1, 1, 0),
         ABX = if_else(Num_of_ABX>=1, 1, 0)) %>% 
  select(deid_enc_id, PPI, GAS, ABX)

# Instead of number of ... should this just be a binary variable indicating receipt of PPI/Gastric Acid Supplement/ABX (coded as 1=yes or 0=no)? Section commented above handles this. Can remove this chunk of code if decide it's better to have frequency counts for PPI/GAS/ABX. 
```

# Clean `dx` table - create table `dbm` to indicate diabetes mellitus (DBM) diagnoses
```{r Clean `dx` table, create table to indicates DBM dx}
dbm <- dx %>% 
  select(deid_enc_id, dx_group) %>% 
  mutate(DBM = if_else(dx_group=="DIABETES MELLITUS", 1, 0)) %>%
  select(-dx_group) %>% 
  group_by(deid_enc_id) %>% 
  summarize(n_dbm = sum(DBM)) %>% 
  mutate(DBM = if_else(n_dbm>=1, 1, 0)) %>% 
  select(-n_dbm)

#Note: Only have diabetes diagnosis (y/n) for 1,210 patients out of 54,955.

```

# Join `dm`, `med`, and `dbm` table and assign to `df_._CDI`
```{r Merge all tables}
df_CDI <- dm %>% 
  inner_join(med, by = 'deid_enc_id') %>% 
  left_join(dbm, by = "deid_enc_id") %>% 
  rename(ID = deid_enc_id)
```

# Preview and explore resulting dataset
```{r Preview and explore `df_CDI`}
# Preview dataset and check variables types 
str(df_CDI)

# Use DT package to explore dataset
DT::datatable(df_CDI)
```

# Calculate descriptives for categorical variables in `df_CDI`
```{r Create table one of descriptives}
tableone <- CreateCatTable(data=df_CDI, vars=c("readmit", "ED_dispo", "age_gte_65", "cdif_gt_2_days", "PPI", "GAS", "ABX", "DBM"))

print(tableone, showAllLevels = T, noSpaces = T)

# Missing data on DBM diagnosis for ~97% of patients. 
# For binary variables, 1 = YES and 0 = NO. 
```

# Save resulting dataset `df_CDI` as .csv file 
```{r Save resulting dataset as .csv file}
write_csv(df_CDI, "/Users/sreynolds2/Documents/GitHub/MS-CDI_Risk/MS-CDI_Risk/data/clean/df_CDI_risk_model.csv")
```


# Next Steps 

  * Create multivariate logistic regression model, divide data into 3 chunks/time periods (e.g. 2019, 2020, 2021)
    + 1 chunk used to train model, the other 2 used to evaluate model performance (e.g. 2019 chunk used to train model, while 2020-2021 used to test model performance)
  * Evaluate "model creep" or how much the optimized model changes over time? 
  * Question: What proportion of C diff cases occurred 2+ days after admission vs. within 2 days of admission? 

```{r, eval = FALSE}
# Idea of what next steps would look like... first have to normalize/transform data and meet assumptions of logistic regression... 

# For example, first look at correlation between age >= 65 and c diff dx. 
cor(df_CDI$age_gte_65, df_CDI$cdif_gt_2_days, use = "complete.obs", method = "kendall")

m1 <- glm(cdif_gt_2_days ~ age_gte_65 + readmit + DBM + PPI + GAS + ABX, data = df_CDI, family = binomial)

summary(m1)
```

# End of Document