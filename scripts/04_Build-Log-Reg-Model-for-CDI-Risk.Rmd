---
title: "Build Logistic Regression Model for CDI Risk"
author: "Steph Reynolds"
date: "`r format(Sys.time(), '%b %d, %Y  %H:%M %p')`"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Background

## Project

MINDSCAPE: Modeling of infectious network dynamics for surveillance, control and prevention enhancement

## Description

This file reads in `df.CDI` and checks the assumptions for creating a logistic regression model to evaluate C diff risk among hospitalized patients.

## Outcome/Dependent Variable:

*Outcome is binary.*

-   `HACDIF` --\> whether patient is diagnosed with hospital- acquired C diff
    -   In other words, whether pt obtained C diff \> 2 days after hospital admission

## Predictor/Independent Variables:

*All predictors are binary.*

-   `ID` --\> each patient's unique de-identified encounter ID
-   `readmit` --\> whether patient had a prior hospital admission in the last 30 days
-   `ED_dispo` --\> whether pt was admitted from Emergency Dept (ED) ???
    -   NOTE: UNCLEAR! VERIFY / LEO WHAT THIS SHOULD BE TO INDICATE THAT PT WAS ADMITTED TO ED!
-   `age_gte_65` --\> whether pt is aged 65 years or older at time of hospitalization
-   `PPI` --\> whether pt received proton pump inhibitor (PPI) during hospital stay
-   `GAS` --\> whether pt received gastric acid suppressants (GAS) during hospital stay
    -   NOTE: This includes "ANTACIDS" and "HISTAMINE H2-RECEPTOR INHIBITORS"
    -   Could this be coded as anything else in `pharm_class`?
-   `anyGAS` --\> whether pt received PPI and/or GAS during hospital stay
-   `LAX` --\> whether pt received laxatives (LAX) during hospital stay
    -   NOTE: This includes "LAXATIVES AND CATHARTICS" and "LAXATIVES, LOCAL/RECTAL"
-   `ABX` --\> whether pt received antibiotics during hospital stay
    -   NOTE: THIS DOES NOT INCLUDE OUTPATIENT ABX - ONLY THOSE DURING HOSPITALIZATION.
-   `DBM` --\> whether pt is diagnosed with diabetes mellitus (DBM)
    -   NOTE: DO NOT USE! ONLY HAVE DBM DX FOR COVID POSITIVE PTS.

# Load required packages

```{r Load required packages}
library(tidyverse)
library(corrplot) #correlation matrix to test multi-collinearity of IVs 
library(pROC) #plot ROC and calculate AUROC (to evaluate performance of model)
```

# Import `df_CDI_risk_model.csv` and select only necessary variables

```{r Import data}
df <- read_csv("/Users/sreynolds2/Documents/GitHub/MS-CDI_Risk/MS-CDI_Risk/data/clean/df_CDI_risk_model.csv") %>% 
  select(-c(ID, ED_dispo))
```

# Check Assumptions of Logistic Regression

**Source: <https://www.lexjansen.com/wuss/2018/130_Final_Paper_PDF.pdf>**

## Appropriate Outcome Structure

Binary log reg requires DV to be binary. Whether a pt is diagnosed with C diff is binary.

## Observation Independence

Observations are independent from each other. Each patient is unique. Not matched or repeated measures data.

## Absence of Multicollinearity

There should be little or no multicollinearity among IVs. We can test this assumption with a correlation matrix. Make sure no two variables have a correlation coefficient of roughly 0.8 or higher.

### Correlation matrix

```{r Correlation matrix}
# Create correlation matrix to check whether indep vars are correlated with each other
corrplot(cor(df), method = 'number', type = 'lower') 

# As per matrix, variables ABX and PPI are moderately correlated (correl coeff = 0.78)
```

## Linearity of Independent Variables and Log Odds

Continuous IVs must be linearly related to the logit of the outcome. We can test this by visualizing scatterplot between each predictor and logit values. Since all IVs are binary, can ignore this step.

## Large Sample Size

General guideline is to have at least 10 cases with least frequent outcome for each IV/predictor variable in your model.

Since our model includes **8 predictors** and the probability of HA-CDI = 329/55037 = **0.006**, then we would like a sample size of about (10\*8/.006) = **13,334**. If we include `ED_dispo` and `DBM`, we would have 10 predictors, and thus, would aim for a sample size of about 16,667. Thus, our model easily meets this requirement.

# Build logistic regression model

```{r Build logistic regression model}
m <- glm(data = df, formula = HACDIF ~ readmit + age_gte_65 + PPI + GAS + anyGAS + LAX + ABX + AMR, family = binomial)
summary(m)

# Model 
m.b <- glm(data = df, formula = HACDIF ~ readmit + age_gte_65 + PPI + GAS + LAX + ABX, family = binomial(link = "cloglog"))
summary(m.b)

m.c <- glm(data = df, formula = HACDIF ~ readmit + age_gte_65 + PPI + GAS + LAX + ABX, family = binomial)
summary(m.c)
```

# Calculate AUROC to evaluate model performance

```{r Calculate AUROC}
logit_prob <- predict(m, newdata = df, type = 'response') 

logit_roc <- pROC::roc(df$HACDIF ~ logit_prob, plot = T, print.auc = T)
```

Since our model suggests `anyGAS`, `ABX`, and `AMR` to be the least significant predictors, we will re-run this model WITHOUT them.

```{r Build log reg model 2}
m2 <- glm(data = df, formula = HACDIF ~ readmit + age_gte_65 + PPI + GAS, family = binomial)

summary(m2)
```

Since all predictors were significant (p\<=.05), we can keep model 2 and evaluate its performance by calculating the area under the receiving operator curve (AUROC or AUC).

# Calculate AUROC to evaluate model 2 performance

```{r Calculate AUROC}
logit_prob <- predict(m2, newdata = df, type = 'response')

logit_roc <- pROC::roc(df$HACDIF ~ logit_prob, plot = T, print.auc = T)
```

The AUROC is 0.74 which shows that the model is fairly accurate at predicting whether a patient will be diagnosed with C diff given the following risk factors (age\>=65, readmit, and whether they received proton pump inhibitor and/or gastric acid suppressant).
